# AgentCore Agents 

## ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¸€è¦§

### **0 ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**

* **ç›®çš„:** ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®ã¿ã‚’æä¾›ã™ã‚‹ã€AgentCoreã®ãƒ™ãƒ¼ã‚¹Agent
* **æŠ€è¡“:** Strandsã§LLMã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹

---

### **â‘  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆæ”¯æ´ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**

* **ç›®çš„:** Bedrock AgentCoreã®ãƒ¡ãƒ¢ãƒªæ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã€éå»ã®ä¼šè©±ã‚„çŸ¥è­˜ã‚’å‚ç…§ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚’æ”¯æ´ã™ã‚‹ã€‚
* **å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ:** çŸ­æœŸãƒ¡ãƒ¢ãƒªï¼ˆShort-termï¼‰ã¨é•·æœŸãƒ¡ãƒ¢ãƒªï¼ˆLong-termï¼‰ã®é€£æºã«ã‚ˆã‚‹æ–‡è„ˆä¿æŒã€‚
* **æŠ€è¡“:** AWS Bedrock AgentCore Memoryãƒ»Strands Agentãƒ»Bedrock Modelã‚’çµ±åˆã€‚
* **ãƒ‡ãƒ¢ä¾‹:** ã€Œä»Šé€±ã®é€²æ—ã‚’ã¾ã¨ã‚ã¦ã€ã¨å…¥åŠ› â†’ éå»ã®ä¼šè©±ã¨çŸ¥è­˜ã‚’å‚ç…§ã—ã¦è¦ç´„ã‚’ç”Ÿæˆã€‚

---

### **â‘¡ ã‚¿ã‚¹ã‚¯åˆ†è§£ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**

* **ç›®çš„:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®æ¨™ã‚’åˆ†è§£ã—ã€ãƒªã‚µãƒ¼ãƒã¨çµ±åˆã‚’è¡Œã£ã¦å®Ÿè¡Œå¯èƒ½ãªãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã™ã‚‹ã€‚
* **å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ:** LangGraphã‚’ç”¨ã„ãŸã‚¹ãƒ†ãƒƒãƒ—å‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹ç¯‰ã¨ã€å¤–éƒ¨æ¤œç´¢ï¼ˆDuckDuckGoï¼‰é€£æºã€‚
* **æŠ€è¡“:** LangGraphãƒ»LangChain Community Toolsãƒ»AWS Bedrock AgentCoreãƒ»Strands Agentã‚’çµ„ã¿åˆã‚ã›ã€‚
* **ãƒ‡ãƒ¢ä¾‹:** ã€Œæ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æº–å‚™ã‚’ã—ãŸã„ã€ã¨å…¥åŠ› â†’ åˆ†è§£â†’èª¿æŸ»â†’çµ±åˆã®3æ®µéšã§å®Ÿè¡Œè¨ˆç”»ã‚’ç”Ÿæˆã€‚

---

### **â‘¢ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”ã‚¿ã‚¹ã‚¯åˆ†è§£ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**

* **ç›®çš„:** LangGraphã‚’ç”¨ã„ã¦ã€è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®å‡¦ç†çµæœã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¿”ã™ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ã€‚
* **å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ:** SSEï¼ˆServer-Sent Eventsï¼‰ã«ã‚ˆã‚‹æ®µéšçš„å¿œç­”ã¨ã€LangGraphã®ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œåˆ¶å¾¡ã€‚
* **æŠ€è¡“:** LangGraphãƒ»LangChain AWSï¼ˆChatBedrockï¼‰ãƒ»AWS Bedrock AgentCoreã‚’é€£æºã€‚
* **ãƒ‡ãƒ¢ä¾‹:** ã€Œæ˜æ—¥åå¤å±‹ã«è¡Œãè¨ˆç”»ã‚’ç«‹ã¦ã¦ã€ã¨ä¾é ¼ â†’ å„ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆåˆ†è§£â†’èª¿æŸ»â†’çµ±åˆï¼‰ã®çµæœã‚’é †ã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡ºåŠ›ã€‚

---

### **â‘£ CodeInterpreterã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**

- **ç›®çš„:**  ç”Ÿæˆã—ãŸå›ç­”ã‚’å®Ÿéš›ã®Pythonã‚³ãƒ¼ãƒ‰ã§æ¤œè¨¼ã—ã€è¨ˆç®—ãƒ»è«–ç†ãƒ»ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ­£ç¢ºæ€§ã‚’ç¢ºèªã™ã‚‹ã€‚
- **å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ:**  Bedrock AgentCoreã®Code Interpreteræ©Ÿèƒ½ã‚’ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦çµ±åˆã—ã€Strands AgentçµŒç”±ã§å®Ÿè¡Œãƒ»çµæœæ¤œè¨¼ã‚’è¡Œã†ã€‚
- **æŠ€è¡“:**  AWS Bedrock AgentCoreãƒ»Strands Agentãƒ»Bedrock Modelãƒ»Code Interpreter Client ã‚’é€£æºã€‚
- **ãƒ‡ãƒ¢ä¾‹:**  ã€ŒCan all the planets in the solar system fit between the earth and moon?ã€ã¨å…¥åŠ› â†’  ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆãƒ»å®Ÿè¡Œã—ã€è¨ˆç®—çµæœã‚’åŸºã«çµè«–ã‚’æç¤ºã€‚


---


## ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ

```
ai-agents/
â”œâ”€ agents/
â”‚  â”œâ”€ 00_base_agent/
â”‚  â”œâ”€ 01_pm_support_bot/
â”‚  â”œâ”€ 02_task_planner/
â”‚  â”œâ”€ 03_sse_agent_bot/
â”‚  â””â”€ 04_code_interpreter_bot/
â”œâ”€ common/ # ã„ãšã‚Œä½œã‚‹
â”‚  â”œâ”€ utils/
â”‚  â”œâ”€ memory/
â”‚  â””â”€ config/
â””â”€ README.md
```


## IAM

* BedrockAgentCorePolicy

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "ECRImageAccess",
            "Effect": "Allow",
            "Action": [
                "ecr:BatchGetImage",
                "ecr:GetDownloadUrlForLayer"
            ],
            "Resource": [
                "arn:aws:ecr:us-east-1:xxxxxxxxxxxx:repository/*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "logs:DescribeLogStreams",
                "logs:CreateLogGroup"
            ],
            "Resource": [
                "arn:aws:logs:us-east-1:xxxxxxxxxxxx:log-group:/aws/bedrock-agentcore/runtimes/*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "logs:DescribeLogGroups"
            ],
            "Resource": [
                "arn:aws:logs:us-east-1:xxxxxxxxxxxx:log-group:*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ],
            "Resource": [
                "arn:aws:logs:us-east-1:xxxxxxxxxxxx:log-group:/aws/bedrock-agentcore/runtimes/*:log-stream:*"
            ]
        },
        {
            "Sid": "ECRTokenAccess",
            "Effect": "Allow",
            "Action": [
                "ecr:GetAuthorizationToken"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "xray:PutTraceSegments",
                "xray:PutTelemetryRecords",
                "xray:GetSamplingRules",
                "xray:GetSamplingTargets"
            ],
            "Resource": [
                "*"
            ]
        },
        {
            "Effect": "Allow",
            "Resource": "*",
            "Action": "cloudwatch:PutMetricData",
            "Condition": {
                "StringEquals": {
                    "cloudwatch:namespace": "bedrock-agentcore"
                }
            }
        },
        {
            "Sid": "GetAgentAccessToken",
            "Effect": "Allow",
            "Action": [
                "bedrock-agentcore:GetWorkloadAccessToken",
                "bedrock-agentcore:GetWorkloadAccessTokenForJWT",
                "bedrock-agentcore:GetWorkloadAccessTokenForUserId"
            ],
            "Resource": [
                "arn:aws:bedrock-agentcore:us-east-1:xxxxxxxxxxxx:workload-identity-directory/default",
                "arn:aws:bedrock-agentcore:us-east-1:xxxxxxxxxxxx:workload-identity-directory/default/workload-identity/agentName-*"
            ]
        },
        {
            "Sid": "BedrockModelInvocation",
            "Effect": "Allow",
            "Action": [
                "bedrock:InvokeModel",
                "bedrock:InvokeModelWithResponseStream"
            ],
            "Resource": [
                "arn:aws:bedrock:*::foundation-model/*",
                "arn:aws:bedrock:us-east-1:xxxxxxxxxxxx:*"
            ]
        },
        {
            "Effect": "Allow",
            "Action": [
                "bedrock-agentcore:ListEvents",
                "bedrock-agentcore:CreateEvent",
                "bedrock-agentcore:GetEvent",
                "bedrock-agentcore:ListMemories",
                "bedrock-agentcore:GetMemory"
            ],
            "Resource": [
                "arn:aws:bedrock-agentcore:us-east-1:xxxxxxxxxxxx:memory/*"
            ]
        }
    ]
}
```


## å¾—ãŸå­¦ã³
### 1 Memory

* Short Term Memoryã®èª­ã¿å–ã‚Šã¨Long Term Memoryã®èª­ã¿å–ã‚Šã®Permissionã¯ç•°ãªã‚‹ã€‚
* Long Term Memoryã®èª­ã¿å–ã‚Šã«ã¯ã€`bedrock-agentcore:RetrieveMemoryRecords` ãŒå¿…è¦ã ã£ãŸã€‚

```
		{
			"Effect": "Allow",
			"Action": [
				"bedrock-agentcore:ListEvents",
				"bedrock-agentcore:CreateEvent",
				"bedrock-agentcore:GetEvent",
				"bedrock-agentcore:ListMemories",
				"bedrock-agentcore:GetMemory",
				"bedrock-agentcore:RetrieveMemoryRecords"
			],
			"Resource": [
				"arn:aws:bedrock-agentcore:us-east-1:xxxxxxxxxxxx:memory/*"
			]
		}
```

### 3 SSE
* yieldã§è‡ªåœ¨ã«é€”ä¸­ã®ãƒªã‚¿ãƒ¼ãƒ³ã‚’è¿”å´ã§ãã‚‹ã€‚


### 4 Code Interpreter
* Tool ã¨ã—ã¦CodeInterpreterã‚’ç™»éŒ²ã—ãŸã‚‰ã€é©åˆ‡ãªå›ç­”ã‚’è¿”ã™ã¾ã§è¤‡æ•°å›ã®Interpreterå‘¼ã³å‡ºã—ãŒè¡Œã‚ã‚Œã†ã‚‹ã€‚
<<<<<<< HEAD
=======

### 5. Agent with Auth
* ç’°å¢ƒå¤‰æ•°ã¯ã€`agentcore launch` ã‚³ãƒãƒ³ãƒ‰ã®å¼•æ•°ã§ç°¡å˜ã«æŒ‡å®šã§ãã‚‹

```
agentcore launch --env OPENAI_API_KEY="sk-proj-xxxxxxxx"
```

* Cognitoã®UserPoolã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆå›è¿½åŠ ã—ãŸçŠ¶æ…‹ã§ã¯ã€APIã§ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒã§ããªã„ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆå›ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦PWå¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€åˆã‚ã¦æœ‰åŠ¹åŒ–ã•ã‚Œã‚‹ã€‚
* IDProviderã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯USERNAME/PASSWORDã§ã®èªè¨¼ã¯Disableã«ãªã£ã¦ã„ã‚‹ã€‚Enableã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ã‚ã¨ã‹ã‚‰å¤‰æ›´ã‚‚ã§ãã‚‹ã€‚

#### ğŸ”‘ èªè¨¼ä»˜ã AgentCore å‘¼ã³å‡ºã—ã®ãƒã‚¤ãƒ³ãƒˆã¾ã¨ã‚

---

##### ğŸ§© 1. èªè¨¼ãƒ¢ãƒ¼ãƒ‰ã‚’ã€ŒOAuthã€ã«è¨­å®šã™ã‚‹

- AgentCore Runtime ã‚’ä½œã‚‹ã¨ãã«ã€  
    Cognito ã®è¨­å®šï¼ˆ`discoveryUrl` ã¨ `allowedClients`ï¼‰ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
- ã“ã‚Œã‚’è¨­å®šã—ãªã„ã¨ IAM èªè¨¼ãƒ¢ãƒ¼ãƒ‰æ‰±ã„ã«ãªã‚Šã€OAuth ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡è¦–ã•ã‚Œã‚‹ã€‚
    

---

##### ğŸ” 2. Cognito ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã€ŒClient Secretã€ãŒã‚ã‚‹å ´åˆã¯å¿…ãš SECRET_HASH ã‚’ä½¿ã†

- Cognito ã® App Client ã‚’ â€œSecret ä»˜ãâ€ ã§ä½œã£ãŸã‚‰ã€  
    ãã® Secret ã§ç½²åã—ãŸ `SECRET_HASH` ã‚’é€ã‚‰ãªã„ã¨èªè¨¼ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚
- Secret ç„¡ã—ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãªã‚‰ä¸è¦ã€‚

---

##### ğŸ‘¤ 3. Cognito ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ŒForce change passwordã€ã‚’è§£é™¤ã—ã¦ãŠã

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆç›´å¾Œã¯ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰çŠ¶æ…‹ã«ãªã£ã¦ã„ã¦ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„ã€‚
- ç®¡ç†è€…ã‚³ãƒãƒ³ãƒ‰ã‚„ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ **ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ’ä¹…åŒ–ã€** ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã€‚

---

##### ğŸš« 4. boto3 ã§ã¯ OAuth Agent ã‚’ç›´æ¥å‘¼ã¹ãªã„

- `boto3.client('bedrock-agentcore')` ã¯ IAM ç”¨ï¼ˆSigV4ï¼‰å°‚ç”¨ã€‚
- OAuth èªè¨¼ã§å‘¼ã¶å ´åˆã¯ **`requests.post()` ã§ HTTPS ç›´æ¥å‘¼ã³å‡ºã—** ãŒå¿…è¦ã€‚

---

##### ğŸŸï¸ 5. Token ã®ç¨®é¡ã«æ³¨æ„

- Cognito ã¯ 3 ç¨®ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã™ï¼š
    - AccessToken âœ… â†’ APIå‘¼ã³å‡ºã—ç”¨ï¼ˆã“ã‚Œã‚’ä½¿ã†ï¼‰
    - IdToken âŒ â†’ è¡¨ç¤ºç”¨
    - RefreshToken â†’ å†èªè¨¼ç”¨
- AgentCore ã«æ¸¡ã™ã®ã¯ **AccessToken** ä¸€æŠã€‚
    

---

##### ğŸŒ 6. æ­£ã—ã„å‘¼ã³å‡ºã—URLã‚’ä½¿ã†

- Agent å‘¼ã³å‡ºã—ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯  
    `/runtimes/{AgentARN}/invocations`ã€‚
- `/identities/oauth2/invoke` ã¯åˆ¥ç”¨é€”ï¼ˆä½¿ã‚ãªã„ï¼‰ã€‚


### 6. fastapi_agent
* Agentcore-starter-kitã‚’ä½¿ã‚ãªã„å ´åˆã¯ã€è‡ªåˆ†ã§ECRã«Dockerãƒ“ãƒ«ãƒ‰ã—ã¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ã‚„ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€DockerãŒå‹•ã‹ã›ã‚‹ç’°å¢ƒã§ãªã„ã¨ä½¿ãˆãªã„ã€‚

- ğŸš€ ECR ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ï¼ˆus-east-1 / fastapi_agentï¼‰
	- ğŸ§± ãƒªãƒã‚¸ãƒˆãƒªä½œæˆ
	- aws ecr create-repository --repository-name fastapi_agent --region us-east-1

- ğŸ” ECR ãƒ­ã‚°ã‚¤ãƒ³
	- aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin <ccount_id>.dkr.ecr.us-east-1.amazonaws.com

- ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰ï¼†ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆARM64å¯¾å¿œï¼‰
	- docker buildx build --platform linux/arm64 -t <account_id>.dkr.ecr.us-east-1.amazonaws.com/fastapi_agent:latest --push .

- ğŸ” ãƒ—ãƒƒã‚·ãƒ¥ç¢ºèª
	- aws ecr describe-images --repository-name fastapi_agent --region us-east-1

### 7. customer support agent.

* AWS SSM
>>>>>>> 76c87af (add auth)
